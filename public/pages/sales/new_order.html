<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°ç™‚ç¨‹å–® - Clinext é†«ç™‚ç¾å®¹ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* å‹•ç•«æ•ˆæœ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>

<body class="bg-gray-50 pb-24">
    <!-- é ‚éƒ¨å°èˆª -->
    <div
        class="bg-gradient-to-r from-green-600 to-green-700 text-white px-4 py-3 flex items-center justify-between sticky top-0 z-20 shadow-md">
        <div class="flex items-center gap-3">
            <a href="../staff/dashboard.html" class="text-white hover:bg-white/10 p-1 rounded-full transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </a>
            <div>
                <h1 class="text-lg font-semibold">æ–°ç™‚ç¨‹å–®</h1>
                <p class="text-xs text-white/80">é†«ç™‚ç¾å®¹æ²»ç™‚è¨˜éŒ„</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">v2.0</span>
            <a href="../calendar.html" class="text-xs bg-white text-green-700 px-2 py-1 rounded-full hover:bg-gray-100">è¡Œäº‹æ›†</a>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
    <div class="px-4 py-4 space-y-4">
        <!-- æ‚£è€…è³‡æ–™å€å¡Š -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="p-4 border-b border-gray-100">
                <h2 class="font-semibold text-gray-800 flex items-center gap-1">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    æ‚£è€…è³‡æ–™
                </h2>
            </div>
            <div class="p-4 space-y-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-1">
                        <span class="text-red-500">*</span>
                        <span class="text-gray-800 font-medium">æ‚£è€…é¸æ“‡</span>
                    </div>
                    <button id="selectPatientBtn"
                        class="flex items-center gap-2 text-green-600 hover:text-green-700 transition-colors">
                        <span class="text-gray-600" id="selectedPatient">é¸æ“‡æ‚£è€…</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>

                <div id="patientInfo" class="hidden bg-gray-50 rounded-lg p-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-900" id="patientName">-</h4>
                            <div class="flex items-center gap-3 mt-1 text-sm">
                                <span class="text-gray-600" id="patientGender">-</span>
                                <span class="text-gray-600" id="patientAge">-</span>
                                <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs"
                                    id="patientSkinType">-</span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1" id="patientMedicalHistory">-</p>
                        </div>
                        <button id="changePatientBtn" class="text-blue-600 text-sm">è®Šæ›´</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç™‚ç¨‹è³‡è¨Šå€å¡Š -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100">
            <div class="p-4 border-b border-gray-100">
                <h2 class="font-semibold text-gray-800 flex items-center gap-1">
                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                    </svg>
                    ç™‚ç¨‹è³‡è¨Š
                </h2>
            </div>
            <div class="p-4 space-y-3">
                <!-- æ—¥æœŸ -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-gray-800">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span class="font-medium">æ²»ç™‚æ—¥æœŸ</span>
                    </div>
                    <button id="selectDateBtn" class="flex items-center gap-2 text-green-600 hover:text-green-700 transition-colors">
                        <span class="text-gray-800 font-medium" id="currentDate">2025-12-25</span>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>

                <!-- é†«å¸« -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-gray-800">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="font-medium">ä¸»æ²»é†«å¸«</span>
                    </div>
                    <button id="selectDoctorBtn" class="flex items-center gap-2 text-green-600 hover:text-green-700 transition-colors">
                        <span class="text-gray-600" id="selectedDoctorName">é¸æ“‡é†«å¸«</span>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>

                <!-- è­·ç†å¸« -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-gray-800">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <span class="font-medium">è­·ç†å¸«</span>
                    </div>
                    <button id="selectNurseBtn" class="flex items-center gap-2 text-green-600 hover:text-green-700 transition-colors">
                        <span class="text-gray-800 font-medium" id="staffName">é¸æ“‡è­·ç†å¸«</span>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ ç™‚ç¨‹æŒ‰éˆ• -->
        <div class="flex gap-3 pt-2">
            <button id="selectTreatmentBtn"
                class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white rounded-xl px-4 py-4 flex items-center justify-center gap-3 shadow-md transition-all active:scale-95">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
                <span class="font-semibold">é¸æ“‡ç™‚ç¨‹</span>
            </button>

            <button id="scanTreatmentBtn"
                class="flex-1 bg-gradient-to-r from-cyan-500 to-cyan-600 hover:from-cyan-600 hover:to-cyan-700 text-white rounded-xl px-4 py-4 flex items-center justify-center gap-3 shadow-md transition-all active:scale-95">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                </svg>
                <span class="font-semibold">æƒç¢¼æ·»åŠ </span>
            </button>
        </div>

        <!-- å·²é¸ç™‚ç¨‹æ¸…å–® -->
        <div id="treatmentList" class="space-y-3 hidden">
            <div class="flex items-center justify-between pt-4">
                <h3 class="text-lg font-bold text-gray-800">å·²é¸ç™‚ç¨‹</h3>
                <span class="text-sm text-gray-500" id="treatmentCount">0 é …ç™‚ç¨‹</span>
            </div>
        </div>

        <!-- æ²»ç™‚è©³ç´°è³‡æ–™è¡¨å–® -->
        <div id="treatmentDetails" class="space-y-4 hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4">æ²»ç™‚è©³ç´°è³‡æ–™</h3>

                <!-- åŠ‘é‡/èƒ½é‡è¨­å®š -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ²»ç™‚åŠ‘é‡/èƒ½é‡</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <input type="number" id="dosageValue" placeholder="æ•¸å€¼"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <select id="dosageUnit"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="U">å–®ä½ (U)</option>
                                    <option value="æ¢">æ¢æ•¸</option>
                                    <option value="cc">æ¯«å‡ (cc)</option>
                                    <option value="ç™¼">ç™¼æ•¸</option>
                                    <option value="æ¬¡">æ¬¡æ•¸</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- æ²»ç™‚éƒ¨ä½ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ²»ç™‚éƒ¨ä½</label>
                        <div class="flex flex-wrap gap-2">
                            <button
                                class="treatment-area-btn px-3 py-1.5 border border-gray-300 rounded-full text-sm hover:bg-purple-50 hover:border-purple-300 transition-colors"
                                data-area="å·¦è‡‰">å·¦è‡‰</button>
                            <button
                                class="treatment-area-btn px-3 py-1.5 border border-gray-300 rounded-full text-sm hover:bg-purple-50 hover:border-purple-300 transition-colors"
                                data-area="å³è‡‰">å³è‡‰</button>
                            <button
                                class="treatment-area-btn px-3 py-1.5 border border-gray-300 rounded-full text-sm hover:bg-purple-50 hover:border-purple-300 transition-colors"
                                data-area="é¡é ­">é¡é ­</button>
                            <button
                                class="treatment-area-btn px-3 py-1.5 border border-gray-300 rounded-full text-sm hover:bg-purple-50 hover:border-purple-300 transition-colors"
                                data-area="ä¸‹å·´">ä¸‹å·´</button>
                            <button
                                class="treatment-area-btn px-3 py-1.5 border border-gray-300 rounded-full text-sm hover:bg-purple-50 hover:border-purple-300 transition-colors"
                                data-area="æ³•ä»¤ç´‹">æ³•ä»¤ç´‹</button>
                        </div>
                        <input type="text" id="treatmentAreaInput" placeholder="å…¶ä»–éƒ¨ä½..."
                            class="w-full mt-3 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent hidden">
                    </div>

                    <!-- ä½¿ç”¨è¨­å‚™/è—¥å“ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä½¿ç”¨è¨­å‚™/è—¥å“</label>
                        <select id="deviceUsed"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">é¸æ“‡è¨­å‚™æˆ–è—¥å“</option>
                            <option value="HIFU_LIFTING">æµ·èŠ™éŸ³æ³¢å„€</option>
                            <option value="PICO_LASER">çš®ç§’é›·å°„å„€</option>
                            <option value="THERMAGE">é³³å‡°é›»æ³¢å„€</option>
                            <option value="BOTOX_US">ç¾åœ‹è‚‰æ¯’æ¡¿èŒ</option>
                            <option value="HA_FILLER">ç»å°¿é…¸å¡«å……åŠ‘</option>
                        </select>
                    </div>

                    <!-- è‡¨åºŠå‚™è¨» -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è‡¨åºŠå‚™è¨»</label>
                        <textarea id="clinicalNotes" rows="3" placeholder="è¨˜éŒ„æ²»ç™‚éç¨‹ã€ç‰¹æ®Šåæ‡‰æˆ–æ³¨æ„äº‹é …..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¨‚å–®æ‘˜è¦ -->
        <div id="orderSummary" class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hidden animate-fade-in">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800">è¨‚å–®æ‘˜è¦</h3>
                <span class="text-sm text-gray-500" id="itemCount">å…± 0 é …</span>
            </div>

            <div class="space-y-3">
                <!-- å°è¨ˆ -->
                <div class="flex justify-between items-center py-2">
                    <span class="text-gray-600">ç™‚ç¨‹å°è¨ˆ</span>
                    <span class="text-gray-800 font-semibold" id="subtotal">$0</span>
                </div>

                <!-- æŠ˜æ‰£ -->
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <div class="flex items-center gap-2">
                        <span class="text-gray-600">æŠ˜æ‰£</span>
                        <button id="applyDiscountBtn" class="text-xs text-blue-600 hover:text-blue-700">æ·»åŠ æŠ˜æ‰£</button>
                    </div>
                    <span class="text-green-600 font-semibold" id="discount">-$0</span>
                </div>

                <!-- ç¸½è¨ˆ -->
                <div class="flex justify-between items-center pt-2">
                    <span class="text-gray-800 font-bold text-lg">ç¸½è¨ˆ</span>
                    <span class="text-green-600 font-bold text-xl" id="total">$0</span>
                </div>

                <!-- ä»˜æ¬¾æ–¹å¼ -->
                <div class="pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ä»˜æ¬¾æ–¹å¼</label>
                    <select id="paymentMethod"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="cash">ç¾é‡‘</option>
                        <option value="credit_card">ä¿¡ç”¨å¡</option>
                        <option value="transfer">è½‰å¸³</option>
                        <option value="instalment">åˆ†æœŸä»˜æ¬¾</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™‚ç¨‹é¸æ“‡æ¨¡æ…‹æ¡† -->
    <div id="treatmentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 px-4">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[85vh] overflow-hidden shadow-xl">
            <!-- æ¨¡æ…‹æ¡†æ¨™é ­ -->
            <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-pink-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">é¸æ“‡ç™‚ç¨‹é …ç›®</h3>
                        <p class="text-sm text-gray-500 mt-1">æ ¹æ“šæ‚£è€…éœ€æ±‚é¸æ“‡æ²»ç™‚é …ç›®</p>
                    </div>
                    <button id="closeModalBtn"
                        class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- æœå°‹èˆ‡ç¯©é¸ -->
                <div class="mt-3">
                    <div class="relative">
                        <input type="text" id="treatmentSearch" placeholder="æœå°‹ç™‚ç¨‹åç¨±..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <svg class="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button
                            class="category-filter text-xs px-3 py-1 rounded-full border border-gray-300 hover:bg-gray-50"
                            data-category="all">å…¨éƒ¨</button>
                        <button
                            class="category-filter text-xs px-3 py-1 rounded-full border border-gray-300 hover:bg-gray-50"
                            data-category="injection">æ³¨å°„é¡</button>
                        <button
                            class="category-filter text-xs px-3 py-1 rounded-full border border-gray-300 hover:bg-gray-50"
                            data-category="device">å„€å™¨é¡</button>
                        <button
                            class="category-filter text-xs px-3 py-1 rounded-full border border-gray-300 hover:bg-gray-50"
                            data-category="promotion">ä¿ƒéŠ·æ–¹æ¡ˆ</button>
                    </div>
                </div>
            </div>

            <!-- ç™‚ç¨‹åˆ—è¡¨ -->
            <div class="overflow-y-auto max-h-[60vh] p-4 custom-scrollbar">
                <div class="space-y-3" id="treatmentItemsContainer">
                    <!-- ç™‚ç¨‹é …ç›®å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- æ‚£è€…é¸æ“‡æ¨¡æ…‹æ¡† -->
    <div id="patientModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 px-4">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[85vh] overflow-hidden shadow-xl">
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-gray-800">é¸æ“‡æ‚£è€…</h3>
                    <button id="closePatientModalBtn" class="text-gray-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="mt-3">
                    <input type="text" id="patientSearchInput" placeholder="æœå°‹æ‚£è€…å§“å..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            <div class="overflow-y-auto max-h-[60vh] p-4">
                <div class="space-y-3" id="patientListContainer">
                </div>
            </div>
        </div>
    </div>

    <!-- é†«å¸«é¸æ“‡æ¨¡æ…‹æ¡† -->
    <div id="doctorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 px-4">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[85vh] overflow-hidden shadow-xl">
            <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">é¸æ“‡ä¸»æ²»é†«å¸«</h3>
                        <p class="text-sm text-gray-500 mt-1">é¸æ“‡è² è²¬æœ¬æ¬¡ç™‚ç¨‹çš„é†«å¸«</p>
                    </div>
                    <button id="closeDoctorModalBtn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="overflow-y-auto max-h-[60vh] p-4">
                <div class="space-y-3" id="doctorListContainer">
                </div>
            </div>
        </div>
    </div>

    <!-- è­·ç†å¸«é¸æ“‡æ¨¡æ…‹æ¡† -->
    <div id="nurseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 px-4">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[85vh] overflow-hidden shadow-xl">
            <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-pink-50 to-rose-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">é¸æ“‡è­·ç†å¸«</h3>
                        <p class="text-sm text-gray-500 mt-1">é¸æ“‡å”åŠ©æœ¬æ¬¡ç™‚ç¨‹çš„è­·ç†å¸«</p>
                    </div>
                    <button id="closeNurseModalBtn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="overflow-y-auto max-h-[60vh] p-4">
                <div class="space-y-3" id="nurseListContainer">
                </div>
            </div>
        </div>
    </div>

    <!-- æ—¥æœŸé¸æ“‡æ¨¡æ…‹æ¡† -->
    <div id="dateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 px-4">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-xl">
            <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-teal-50">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-gray-800">é¸æ“‡æ²»ç™‚æ—¥æœŸ</h3>
                    <button id="closeDateModalBtn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-4">
                <input type="text" id="datePicker" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-lg font-medium" readonly>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end gap-3">
                <button id="cancelDateBtn" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                <button id="confirmDateBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨ç¢ºèªæŒ‰éˆ• -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg z-10">
        <div class="flex items-center justify-between mb-2">
            <div>
                <span class="text-sm text-gray-600">ç¸½é‡‘é¡</span>
                <div class="text-xl font-bold text-green-600" id="bottomTotal">$0</div>
            </div>
            <button id="submitOrderBtn"
                class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3 px-8 rounded-full transition-all shadow-md active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                å»ºç«‹ç™‚ç¨‹å–®
            </button>
        </div>
        <p class="text-xs text-gray-500 text-center">é»æ“Šç¢ºèªå»ºç«‹ç™‚ç¨‹å–®ä¸¦è¨˜éŒ„æ²»ç™‚è³‡è¨Š</p>
    </div>

    <script>
        if (typeof flatpickr !== 'undefined' && flatpickr.l10ns && flatpickr.l10ns.zh_tw) {
            flatpickr.localize(flatpickr.l10ns.zh_tw);
        }

        const user = JSON.parse(sessionStorage.getItem('currentUser')) || { name: 'æœªç™»å…¥' };

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('currentDate').textContent = today;

        const doctors = [
            { doctor_id: 'DOC001', full_name: 'å¼µé†«å¸«', license_no: 'DOC-2015-001', specialty: 'å¾®æ•´å½¢æ³¨å°„', status: 'active', avatar: 'ğŸ‘¨â€âš•ï¸' },
            { doctor_id: 'DOC002', full_name: 'æé†«å¸«', license_no: 'DOC-2018-002', specialty: 'é›·å°„å…‰ç™‚', status: 'active', avatar: 'ğŸ‘¨â€âš•ï¸' },
            { doctor_id: 'DOC003', full_name: 'ç‹é†«å¸«', license_no: 'DOC-2020-003', specialty: 'éŸ³æ³¢é›»æ³¢', status: 'active', avatar: 'ğŸ‘©â€âš•ï¸' },
            { doctor_id: 'DOC004', full_name: 'é™³é†«å¸«', license_no: 'DOC-2019-004', specialty: 'çš®è†šç§‘', status: 'active', avatar: 'ğŸ‘©â€âš•ï¸' }
        ];

        const nurses = [
            { staff_id: 'STF001', full_name: 'å¼µè­·ç†å¸«', role: 'nurse', license_no: 'NUR-2016-001', status: 'active', avatar: 'ğŸ‘©â€âš•ï¸' },
            { staff_id: 'STF002', full_name: 'æ—ç¾å®¹å¸«', role: 'therapist', specialty: 'è‡‰éƒ¨ä¿é¤Š', status: 'active', avatar: 'ğŸ’†â€â™€ï¸' },
            { staff_id: 'STF003', full_name: 'é™³é¡§å•', role: 'consultant', specialty: 'ç™‚ç¨‹è«®è©¢', status: 'active', avatar: 'ğŸ‘©â€ğŸ’¼' },
            { staff_id: 'STF004', full_name: 'ç‹è­·ç†å¸«', role: 'nurse', license_no: 'NUR-2018-002', status: 'active', avatar: 'ğŸ‘©â€âš•ï¸' },
            { staff_id: 'STF005', full_name: 'é»ƒç¾å®¹å¸«', role: 'therapist', specialty: 'èº«é«”ç™‚ç¨‹', status: 'active', avatar: 'ğŸ’†â€â™€ï¸' }
        ];

        const treatments = [
            {
                treatment_id: "BOT_MASSETER",
                treatment_code: "BOT_MASSETER",
                treatment_name: "ç¾åœ‹è‚‰æ¯’ç˜¦å°è‡‰",
                category: "injection",
                default_unit: "U",
                base_price: 4999,
                description: "Botox 30Uï¼Œå’¬è‚Œè‚¥åšæ²»ç™‚",
                common_dosage: "30-50U"
            },
            {
                treatment_id: "NABOTA_100U",
                treatment_code: "NABOTA_100U",
                treatment_name: "éŸ“åœ‹è‚‰æ¯’ 100U + å®¹é…·é‡",
                category: "injection",
                default_unit: "U",
                base_price: 8888,
                description: "Nabota 100U + Contour",
                common_dosage: "100U"
            },
            {
                treatment_id: "VERSA_HA_1CC",
                treatment_code: "VERSA_HA_1CC",
                treatment_name: "è–‡è²æ‹‰ç»å°¿é…¸ 1cc",
                category: "injection",
                default_unit: "cc",
                base_price: 12000,
                description: "Versa HA Filler",
                common_dosage: "1cc"
            },
            {
                treatment_id: "HIFU_1000",
                treatment_code: "HIFU_1000",
                treatment_name: "æµ·èŠ™éŸ³æ³¢ 1000æ¢",
                category: "device",
                default_unit: "æ¢",
                base_price: 38000,
                description: "HIFU Liftingï¼Œè‡‰éƒ¨ç·Šç·»",
                common_dosage: "1000æ¢"
            },
            {
                treatment_id: "PICO_LASER",
                treatment_code: "PICO_LASER",
                treatment_name: "çš®ç§’èœ‚å·¢é›·å°„",
                category: "device",
                default_unit: "æ¬¡",
                base_price: 5800,
                description: "Pico Laserï¼Œè‰²ç´ æ–‘æ²»ç™‚",
                common_dosage: "å–®æ¬¡"
            },
            {
                treatment_id: "THERMAGE_HIFU",
                treatment_code: "THERMAGE_HIFU",
                treatment_name: "é³³å‡°é›»æ³¢ 900 + éŸ³æ³¢ 300",
                category: "device",
                default_unit: "ç™¼",
                base_price: 68000,
                description: "Thermage + HIFU Combo",
                common_dosage: "1200ç™¼"
            },
            {
                treatment_id: "FLAWLESS_SKIN",
                treatment_code: "FLAWLESS_SKIN",
                treatment_name: "ç„¡ç‘•è‚Œæ–¹æ¡ˆ",
                category: "promotion",
                default_unit: "æ–¹æ¡ˆ",
                base_price: 10000,
                description: "å››é¸ä¸€ä¿ƒéŠ·æ–¹æ¡ˆ",
                common_dosage: "å››é¸ä¸€"
            }
        ];

        const patients = [
            { patient_id: "PAT001", full_name: "é™³ç¾ç²", gender: "å¥³æ€§", date_of_birth: "1990-05-15", phone: "0912-345-678", skin_type: "IIIå‹", medical_history: "ç„¡é‡å¤§ç—…å²ï¼Œå°ç›¤å°¼è¥¿æ—éæ•" },
            { patient_id: "PAT002", full_name: "æ—å¿—æ˜", gender: "ç”·æ€§", date_of_birth: "1985-08-22", phone: "0933-456-789", skin_type: "IVå‹", medical_history: "é«˜è¡€å£“" },
            { patient_id: "PAT003", full_name: "ç‹å°ç¾", gender: "å¥³æ€§", date_of_birth: "1992-03-10", phone: "0988-777-666", skin_type: "IIå‹", medical_history: "ç„¡" },
            { patient_id: "PAT004", full_name: "å¼µé›…å©·", gender: "å¥³æ€§", date_of_birth: "1988-12-05", phone: "0955-123-456", skin_type: "IIIå‹", medical_history: "å°æŸäº›éº»é†‰è—¥ç‰©æ•æ„Ÿ" },
            { patient_id: "PAT005", full_name: "æå¤§å‰", gender: "ç”·æ€§", date_of_birth: "1978-07-18", phone: "0922-888-999", skin_type: "Vå‹", medical_history: "ç³–å°¿ç—…" },
            { patient_id: "PAT006", full_name: "é»ƒä½³çª", gender: "å¥³æ€§", date_of_birth: "1995-01-28", phone: "0966-555-444", skin_type: "IIå‹", medical_history: "ç„¡" }
        ];

        let selectedTreatments = [];
        let currentPatient = null;
        let selectedDoctor = null;
        let selectedNurse = null;
        let selectedDate = today;
        let selectedTreatmentAreas = [];
        let datePickerInstance = null;

        // è¨ˆç®—å¹´é½¡
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        // åˆå§‹åŒ–æ²»ç™‚é …ç›®åˆ—è¡¨
        function initializeTreatmentItems() {
            const container = document.getElementById('treatmentItemsContainer');
            container.innerHTML = '';

            treatments.forEach(treatment => {
                const item = document.createElement('div');
                item.className = `treatment-item bg-gray-50 rounded-xl p-4 cursor-pointer hover:bg-purple-50 transition-colors border border-gray-200 hover:border-purple-300 ${treatment.category}`;
                item.setAttribute('data-treatment-id', treatment.treatment_id);
                item.setAttribute('data-treatment-code', treatment.treatment_code);
                item.setAttribute('data-treatment-name', treatment.treatment_name);
                item.setAttribute('data-category', treatment.category);
                item.setAttribute('data-base-price', treatment.base_price);
                item.setAttribute('data-default-unit', treatment.default_unit);
                item.setAttribute('data-common-dosage', treatment.common_dosage);
                item.setAttribute('data-description', treatment.description);

                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-semibold text-gray-900">${treatment.treatment_name}</h4>
                                <span class="text-xs px-2 py-0.5 rounded-full ${treatment.category === 'injection' ? 'bg-blue-100 text-blue-700' : treatment.category === 'device' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}">
                                    ${treatment.category === 'injection' ? 'æ³¨å°„é¡' : treatment.category === 'device' ? 'å„€å™¨é¡' : 'ä¿ƒéŠ·æ–¹æ¡ˆ'}
                                </span>
                            </div>
                            <p class="text-sm text-gray-500 mb-2">${treatment.description}</p>
                            <div class="flex items-center gap-3 text-xs text-gray-600">
                                <span>${treatment.default_unit}</span>
                                <span>å»ºè­°: ${treatment.common_dosage}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-purple-600 font-bold text-lg">$${treatment.base_price.toLocaleString()}</span>
                        </div>
                    </div>
                `;

                item.addEventListener('click', function () {
                    selectTreatment(this);
                });

                container.appendChild(item);
            });
        }

        // é¸æ“‡æ²»ç™‚é …ç›®
        function selectTreatment(element) {
            const treatment = {
                id: element.dataset.treatmentId,
                code: element.dataset.treatmentCode,
                name: element.dataset.treatmentName,
                category: element.dataset.category,
                base_price: parseInt(element.dataset.basePrice),
                default_unit: element.dataset.defaultUnit,
                common_dosage: element.dataset.commonDosage,
                description: element.dataset.description,
                dosage_value: '',
                dosage_unit: element.dataset.defaultUnit,
                treatment_area: [],
                device_used: '',
                clinical_notes: ''
            };

            selectedTreatments.push(treatment);
            updateOrderDisplay();

            // é—œé–‰æ¨¡æ…‹æ¡†
            document.getElementById('treatmentModal').classList.add('hidden');
            document.getElementById('treatmentModal').classList.remove('flex');

            // é¡¯ç¤ºæ²»ç™‚è©³ç´°è³‡æ–™å€å¡Š
            document.getElementById('treatmentDetails').classList.remove('hidden');
        }

        // æ›´æ–°è¨‚å–®é¡¯ç¤º
        function updateOrderDisplay() {
            const listEl = document.getElementById('treatmentList');
            const summaryEl = document.getElementById('orderSummary');
            const detailsEl = document.getElementById('treatmentDetails');
            const submitBtn = document.getElementById('submitOrderBtn');
            const treatmentCount = document.getElementById('treatmentCount');
            const itemCount = document.getElementById('itemCount');

            if (selectedTreatments.length > 0) {
                listEl.classList.remove('hidden');
                summaryEl.classList.remove('hidden');
                submitBtn.disabled = false;
                treatmentCount.textContent = `${selectedTreatments.length} é …ç™‚ç¨‹`;
                itemCount.textContent = `å…± ${selectedTreatments.length} é …`;

                // ç”Ÿæˆæ²»ç™‚é …ç›®åˆ—è¡¨
                let html = '';
                selectedTreatments.forEach((t, idx) => {
                    html += `
                        <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm animate-fade-in">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h4 class="font-semibold text-gray-900">${t.name}</h4>
                                        <span class="text-xs px-2 py-0.5 rounded-full ${t.category === 'injection' ? 'bg-blue-100 text-blue-700' : t.category === 'device' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}">
                                            ${t.category === 'injection' ? 'æ³¨å°„é¡' : t.category === 'device' ? 'å„€å™¨é¡' : 'ä¿ƒéŠ·æ–¹æ¡ˆ'}
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        ${t.dosage_value ? `<div>åŠ‘é‡: ${t.dosage_value} ${t.dosage_unit}</div>` : ''}
                                        ${t.treatment_area.length > 0 ? `<div>éƒ¨ä½: ${t.treatment_area.join(', ')}</div>` : ''}
                                        ${t.device_used ? `<div>è¨­å‚™: ${t.device_used}</div>` : ''}
                                    </div>
                                    ${t.clinical_notes ? `<p class="text-sm text-gray-500 mt-2">å‚™è¨»: ${t.clinical_notes}</p>` : ''}
                                </div>
                                <div class="flex items-start gap-3">
                                    <span class="text-purple-600 font-bold whitespace-nowrap">$${t.base_price.toLocaleString()}</span>
                                    <button onclick="removeTreatment(${idx})" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition-colors">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                listEl.innerHTML = html;

                // è¨ˆç®—ç¸½é‡‘é¡
                const subtotal = selectedTreatments.reduce((sum, t) => sum + t.base_price, 0);
                const discount = 0; // å¯ä»¥æ“´å±•æŠ˜æ‰£åŠŸèƒ½
                const total = subtotal - discount;

                document.getElementById('subtotal').textContent = '$' + subtotal.toLocaleString();
                document.getElementById('discount').textContent = '-$' + discount.toLocaleString();
                document.getElementById('total').textContent = '$' + total.toLocaleString();
                document.getElementById('bottomTotal').textContent = '$' + total.toLocaleString();

                // æ›´æ–°æ²»ç™‚è©³ç´°è³‡æ–™è¡¨å–®
                if (selectedTreatments.length > 0) {
                    const lastTreatment = selectedTreatments[selectedTreatments.length - 1];
                    document.getElementById('dosageValue').value = lastTreatment.dosage_value || '';
                    document.getElementById('dosageUnit').value = lastTreatment.dosage_unit || lastTreatment.default_unit;
                    document.getElementById('deviceUsed').value = lastTreatment.device_used || '';
                    document.getElementById('clinicalNotes').value = lastTreatment.clinical_notes || '';
                }
            } else {
                listEl.classList.add('hidden');
                summaryEl.classList.add('hidden');
                detailsEl.classList.add('hidden');
                submitBtn.disabled = true;
                treatmentCount.textContent = '0 é …ç™‚ç¨‹';
            }

            // æª¢æŸ¥æ˜¯å¦å¯ä»¥æäº¤
            checkSubmissionReady();
        }

        // æª¢æŸ¥æ˜¯å¦å¯ä»¥æäº¤è¨‚å–®
        function checkSubmissionReady() {
            const submitBtn = document.getElementById('submitOrderBtn');
            const patientSelected = currentPatient !== null;
            const treatmentsSelected = selectedTreatments.length > 0;

            submitBtn.disabled = !(patientSelected && treatmentsSelected);

            if (!patientSelected) {
                submitBtn.setAttribute('title', 'è«‹å…ˆé¸æ“‡æ‚£è€…');
            } else if (!treatmentsSelected) {
                submitBtn.setAttribute('title', 'è«‹è‡³å°‘é¸æ“‡ä¸€é …ç™‚ç¨‹');
            } else {
                submitBtn.removeAttribute('title');
            }
        }

        // ç§»é™¤æ²»ç™‚é …ç›®
        window.removeTreatment = function (idx) {
            selectedTreatments.splice(idx, 1);
            updateOrderDisplay();

            if (selectedTreatments.length === 0) {
                document.getElementById('treatmentDetails').classList.add('hidden');
            }
        };

        document.getElementById('selectPatientBtn').addEventListener('click', function () {
            document.getElementById('patientModal').classList.remove('hidden');
            document.getElementById('patientModal').classList.add('flex');
        });

        function initializeDoctorList() {
            const container = document.getElementById('doctorListContainer');
            container.innerHTML = doctors.map(doc => `
                <div class="doctor-item bg-gray-50 rounded-xl p-4 cursor-pointer hover:bg-blue-50 transition-colors border border-gray-200 hover:border-blue-300" data-doctor-id="${doc.doctor_id}">
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">${doc.avatar}</div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900">${doc.full_name}</h4>
                            <p class="text-sm text-gray-600">${doc.specialty}</p>
                            <p class="text-xs text-gray-400">åŸ·ç…§: ${doc.license_no}</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </div>
                </div>
            `).join('');

            container.querySelectorAll('.doctor-item').forEach(item => {
                item.addEventListener('click', function () {
                    const doctorId = this.dataset.doctorId;
                    const doctor = doctors.find(d => d.doctor_id === doctorId);
                    if (doctor) {
                        selectedDoctor = doctor;
                        document.getElementById('selectedDoctorName').textContent = doctor.full_name;
                        document.getElementById('selectedDoctorName').classList.remove('text-gray-600');
                        document.getElementById('selectedDoctorName').classList.add('text-gray-800', 'font-medium');
                        document.getElementById('doctorModal').classList.add('hidden');
                        document.getElementById('doctorModal').classList.remove('flex');
                    }
                });
            });
        }

        function initializeNurseList() {
            const container = document.getElementById('nurseListContainer');
            container.innerHTML = nurses.map(nurse => `
                <div class="nurse-item bg-gray-50 rounded-xl p-4 cursor-pointer hover:bg-pink-50 transition-colors border border-gray-200 hover:border-pink-300" data-staff-id="${nurse.staff_id}">
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">${nurse.avatar}</div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900">${nurse.full_name}</h4>
                            <p class="text-sm text-gray-600">${nurse.role === 'nurse' ? 'è­·ç†å¸«' : nurse.role === 'therapist' ? 'ç¾å®¹å¸«' : 'é¡§å•'}</p>
                            <p class="text-xs text-gray-400">${nurse.specialty || nurse.license_no || ''}</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </div>
                </div>
            `).join('');

            container.querySelectorAll('.nurse-item').forEach(item => {
                item.addEventListener('click', function () {
                    const staffId = this.dataset.staffId;
                    const nurse = nurses.find(n => n.staff_id === staffId);
                    if (nurse) {
                        selectedNurse = nurse;
                        document.getElementById('staffName').textContent = nurse.full_name;
                        document.getElementById('nurseModal').classList.add('hidden');
                        document.getElementById('nurseModal').classList.remove('flex');
                    }
                });
            });
        }

        function initializeDatePicker() {
            datePickerInstance = flatpickr('#datePicker', {
                defaultDate: today,
                dateFormat: 'Y-m-d',
                inline: true,
                onChange: function(selectedDates, dateStr) {
                    selectedDate = dateStr;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            initializeTreatmentItems();
            initializeDoctorList();
            initializeNurseList();
            initializeDatePicker();

            // æ²»ç™‚æ¨¡æ…‹æ¡†æ§åˆ¶
            document.getElementById('selectTreatmentBtn').addEventListener('click', function () {
                document.getElementById('treatmentModal').classList.remove('hidden');
                document.getElementById('treatmentModal').classList.add('flex');
            });

            document.getElementById('closeModalBtn').addEventListener('click', function () {
                document.getElementById('treatmentModal').classList.add('hidden');
                document.getElementById('treatmentModal').classList.remove('flex');
            });

            // æ‚£è€…æ¨¡æ…‹æ¡†æ§åˆ¶
            document.getElementById('closePatientModalBtn').addEventListener('click', function () {
                document.getElementById('patientModal').classList.add('hidden');
                document.getElementById('patientModal').classList.remove('flex');
            });

            // é†«å¸«é¸æ“‡æ¨¡æ…‹æ¡†
            document.getElementById('selectDoctorBtn').addEventListener('click', function () {
                document.getElementById('doctorModal').classList.remove('hidden');
                document.getElementById('doctorModal').classList.add('flex');
            });

            document.getElementById('closeDoctorModalBtn').addEventListener('click', function () {
                document.getElementById('doctorModal').classList.add('hidden');
                document.getElementById('doctorModal').classList.remove('flex');
            });

            // è­·ç†å¸«é¸æ“‡æ¨¡æ…‹æ¡†
            document.getElementById('selectNurseBtn').addEventListener('click', function () {
                document.getElementById('nurseModal').classList.remove('hidden');
                document.getElementById('nurseModal').classList.add('flex');
            });

            document.getElementById('closeNurseModalBtn').addEventListener('click', function () {
                document.getElementById('nurseModal').classList.add('hidden');
                document.getElementById('nurseModal').classList.remove('flex');
            });

            // æ—¥æœŸé¸æ“‡æ¨¡æ…‹æ¡†
            document.getElementById('selectDateBtn').addEventListener('click', function () {
                document.getElementById('dateModal').classList.remove('hidden');
                document.getElementById('dateModal').classList.add('flex');
            });

            document.getElementById('closeDateModalBtn').addEventListener('click', function () {
                document.getElementById('dateModal').classList.add('hidden');
                document.getElementById('dateModal').classList.remove('flex');
            });

            document.getElementById('cancelDateBtn').addEventListener('click', function () {
                document.getElementById('dateModal').classList.add('hidden');
                document.getElementById('dateModal').classList.remove('flex');
            });

            document.getElementById('confirmDateBtn').addEventListener('click', function () {
                document.getElementById('currentDate').textContent = selectedDate;
                document.getElementById('dateModal').classList.add('hidden');
                document.getElementById('dateModal').classList.remove('flex');
            });

            // æœå°‹åŠŸèƒ½
            document.getElementById('treatmentSearch').addEventListener('input', function (e) {
                const searchTerm = e.target.value.toLowerCase();
                const items = document.querySelectorAll('.treatment-item');

                items.forEach(item => {
                    const name = item.dataset.treatmentName.toLowerCase();
                    const description = item.dataset.description.toLowerCase();

                    if (name.includes(searchTerm) || description.includes(searchTerm)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });

            // åˆ†é¡ç¯©é¸
            document.querySelectorAll('.category-filter').forEach(button => {
                button.addEventListener('click', function () {
                    const category = this.dataset.category;
                    const items = document.querySelectorAll('.treatment-item');

                    document.querySelectorAll('.category-filter').forEach(btn => {
                        btn.classList.remove('bg-purple-600', 'text-white');
                        btn.classList.add('border-gray-300', 'hover:bg-gray-50');
                    });

                    this.classList.remove('border-gray-300', 'hover:bg-gray-50');
                    this.classList.add('bg-purple-600', 'text-white');

                    items.forEach(item => {
                        if (category === 'all' || item.dataset.category === category) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            });

            // æ²»ç™‚éƒ¨ä½é¸æ“‡
            document.querySelectorAll('.treatment-area-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const area = this.dataset.area;
                    const index = selectedTreatmentAreas.indexOf(area);

                    if (index === -1) {
                        selectedTreatmentAreas.push(area);
                        this.classList.add('bg-purple-600', 'text-white', 'border-purple-600');
                        this.classList.remove('border-gray-300', 'hover:bg-purple-50');
                    } else {
                        selectedTreatmentAreas.splice(index, 1);
                        this.classList.remove('bg-purple-600', 'text-white', 'border-purple-600');
                        this.classList.add('border-gray-300', 'hover:bg-purple-50');
                    }

                    // æ›´æ–°æœ€å¾Œä¸€å€‹æ²»ç™‚é …ç›®çš„éƒ¨ä½
                    if (selectedTreatments.length > 0) {
                        const lastIndex = selectedTreatments.length - 1;
                        selectedTreatments[lastIndex].treatment_area = [...selectedTreatmentAreas];
                        updateOrderDisplay();
                    }
                });
            });

            // æ²»ç™‚è©³ç´°è³‡æ–™è¼¸å…¥
            document.getElementById('dosageValue').addEventListener('input', function () {
                if (selectedTreatments.length > 0) {
                    const lastIndex = selectedTreatments.length - 1;
                    selectedTreatments[lastIndex].dosage_value = this.value;
                }
            });

            document.getElementById('dosageUnit').addEventListener('change', function () {
                if (selectedTreatments.length > 0) {
                    const lastIndex = selectedTreatments.length - 1;
                    selectedTreatments[lastIndex].dosage_unit = this.value;
                    updateOrderDisplay();
                }
            });

            document.getElementById('deviceUsed').addEventListener('change', function () {
                if (selectedTreatments.length > 0) {
                    const lastIndex = selectedTreatments.length - 1;
                    selectedTreatments[lastIndex].device_used = this.value;
                    updateOrderDisplay();
                }
            });

            document.getElementById('clinicalNotes').addEventListener('input', function () {
                if (selectedTreatments.length > 0) {
                    const lastIndex = selectedTreatments.length - 1;
                    selectedTreatments[lastIndex].clinical_notes = this.value;
                    updateOrderDisplay();
                }
            });

            function renderPatientList(patientsList) {
                document.getElementById('patientListContainer').innerHTML = patientsList.map(patient => `
                    <div class="patient-item bg-gray-50 rounded-xl p-4 cursor-pointer hover:bg-green-50 transition-colors border border-gray-200 hover:border-green-300" 
                         data-patient-id="${patient.patient_id}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-gray-900">${patient.full_name}</h4>
                                <div class="flex items-center gap-3 mt-1 text-sm text-gray-600">
                                    <span>${patient.gender}</span>
                                    <span>${calculateAge(patient.date_of_birth)}æ­²</span>
                                    <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">${patient.skin_type}</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">${patient.phone}</p>
                                <p class="text-sm text-gray-500 mt-1">${patient.medical_history}</p>
                            </div>
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </div>
                    </div>
                `).join('');

                document.querySelectorAll('.patient-item').forEach(item => {
                    item.addEventListener('click', function () {
                        const patientId = this.dataset.patientId;
                        const patient = patients.find(p => p.patient_id === patientId);
                        if (patient) {
                            currentPatient = patient;
                            document.getElementById('patientInfo').classList.remove('hidden');
                            document.getElementById('patientName').textContent = patient.full_name;
                            document.getElementById('patientGender').textContent = patient.gender;
                            document.getElementById('patientAge').textContent = `${calculateAge(patient.date_of_birth)}æ­²`;
                            document.getElementById('patientSkinType').textContent = patient.skin_type;
                            document.getElementById('patientMedicalHistory').textContent = patient.medical_history;
                            document.getElementById('patientModal').classList.add('hidden');
                            document.getElementById('patientModal').classList.remove('flex');
                            checkSubmissionReady();
                        }
                    });
                });
            }

            renderPatientList(patients);

            document.getElementById('patientSearchInput').addEventListener('input', function (e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredPatients = patients.filter(p => 
                    p.full_name.toLowerCase().includes(searchTerm) || 
                    p.phone.includes(searchTerm)
                );
                renderPatientList(filteredPatients);
            });

            // è®Šæ›´æ‚£è€…æŒ‰éˆ•
            document.getElementById('changePatientBtn').addEventListener('click', function () {
                document.getElementById('patientModal').classList.remove('hidden');
                document.getElementById('patientModal').classList.add('flex');
            });

            // æäº¤è¨‚å–®
            document.getElementById('submitOrderBtn').addEventListener('click', function () {
                if (!currentPatient) {
                    alert('è«‹å…ˆé¸æ“‡æ‚£è€…');
                    return;
                }

                if (selectedTreatments.length === 0) {
                    alert('è«‹è‡³å°‘é¸æ“‡ä¸€é …ç™‚ç¨‹');
                    return;
                }

                const orderData = {
                    order_id: 'ORD-' + Date.now(),
                    patient: currentPatient,
                    doctor: selectedDoctor ? selectedDoctor.full_name : 'æœªé¸æ“‡',
                    nurse: selectedNurse ? selectedNurse.full_name : 'æœªé¸æ“‡',
                    created_by: user.name,
                    treatment_date: selectedDate,
                    treatments: selectedTreatments,
                    payment_method: document.getElementById('paymentMethod').value,
                    subtotal: selectedTreatments.reduce((sum, t) => sum + t.base_price, 0),
                    discount: 0,
                    total: selectedTreatments.reduce((sum, t) => sum + t.base_price, 0)
                };

                // å„²å­˜åˆ° sessionStorageï¼ˆæ¨¡æ“¬æäº¤ï¼‰
                sessionStorage.setItem('lastOrder', JSON.stringify(orderData));

                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                alert('ç™‚ç¨‹å–®å·²å»ºç«‹æˆåŠŸï¼\nè¨‚å–®ç·¨è™Ÿ: ' + orderData.order_id);

                // è·³è½‰åˆ°å„€è¡¨æ¿
                window.location.href = '../staff/dashboard.html';
            });

            // æ·»åŠ æŠ˜æ‰£æŒ‰éˆ•
            document.getElementById('applyDiscountBtn').addEventListener('click', function () {
                const discountAmount = prompt('è«‹è¼¸å…¥æŠ˜æ‰£é‡‘é¡:', '0');
                if (discountAmount !== null) {
                    const discount = parseInt(discountAmount) || 0;
                    const subtotal = selectedTreatments.reduce((sum, t) => sum + t.base_price, 0);
                    const total = Math.max(0, subtotal - discount);

                    document.getElementById('discount').textContent = '-$' + discount.toLocaleString();
                    document.getElementById('total').textContent = '$' + total.toLocaleString();
                    document.getElementById('bottomTotal').textContent = '$' + total.toLocaleString();
                }
            });
        });
    </script>
</body>

</html>

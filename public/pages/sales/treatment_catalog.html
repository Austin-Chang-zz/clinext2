<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>治療項目目錄 - Clinext</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }

        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .treatment-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
            position: relative;
            overflow: hidden;
        }

        .treatment-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .material-badge {
            background-color: #e0f2fe;
            color: #0369a1;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.85rem;
            display: inline-block;
            margin: 3px;
        }

        .injection-badge {
            background-color: #fef3c7;
            color: #92400e;
        }

        .device-badge {
            background-color: #dcfce7;
            color: #166534;
        }

        .promotion-badge {
            background-color: #f3e8ff;
            color: #7c3aed;
        }

        .status-active {
            background-color: #dcfce7;
            color: #166534;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-inactive {
            background-color: #fef3c7;
            color: #92400e;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* 動畫效果 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* 自定義滾動條 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 表格樣式 */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .table-container table {
            min-width: 1000px;
        }

        .table-container th {
            background-color: #f8fafc;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: #64748b;
            padding: 12px 16px;
            border-bottom: 2px solid #e2e8f0;
        }

        .table-container td {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .table-container tr:hover {
            background-color: #f8fafc;
        }
    </style>
</head>

<body class="text-gray-800 pb-20">
    <!-- 頂部導航 -->
    <div
        class="bg-gradient-to-r from-green-600 to-green-700 text-white px-4 py-3 flex items-center justify-between sticky top-0 z-20">
        <div class="flex items-center gap-3">
            <a href="../staff/dashboard.html" class="text-white hover:bg-white/10 p-1 rounded-full transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </a>
            <h1 class="text-lg font-medium">療程目錄</h1>
        </div>
        <div class="flex items-center gap-3">
            <button id="viewToggle"
                class="text-sm bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full transition-colors flex items-center gap-1">
                <i class="fas fa-th-list text-xs"></i>
                <span>列表檢視</span>
            </button>
            <button id="addTreatmentBtn"
                class="bg-white text-green-700 hover:bg-gray-100 px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 transition-colors">
                <i class="fas fa-plus"></i>
                <span>新增項目</span>
            </button>
        </div>
    </div>

    <!-- 搜尋與篩選區塊 -->
    <div class="px-4 py-4 bg-white border-b border-gray-200">
        <div class="flex flex-col md:flex-row gap-4">
            <!-- 搜尋框 -->
            <div class="flex-1 relative">
                <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                <input type="text" id="searchInput" placeholder="搜尋治療項目名稱、類別或描述..."
                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </div>

            <!-- 篩選按鈕 -->
            <div class="flex gap-2">
                <select id="categoryFilter"
                    class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <option value="">所有類別</option>
                    <option value="injection">注射治療</option>
                    <option value="device">能量儀器</option>
                    <option value="promotion">促銷方案</option>
                    <option value="other">其他治療</option>
                </select>

                <select id="statusFilter"
                    class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <option value="">所有狀態</option>
                    <option value="active">啟用中</option>
                    <option value="inactive">已停用</option>
                </select>
            </div>
        </div>

        <!-- 快速篩選標籤 -->
        <div class="flex flex-wrap gap-2 mt-3">
            <button
                class="quick-filter text-xs px-3 py-1.5 rounded-full border border-gray-300 hover:bg-gray-50 transition-colors"
                data-category="injection">
                <i class="fas fa-syringe mr-1"></i>注射治療
            </button>
            <button
                class="quick-filter text-xs px-3 py-1.5 rounded-full border border-gray-300 hover:bg-gray-50 transition-colors"
                data-category="device">
                <i class="fas fa-microchip mr-1"></i>能量儀器
            </button>
            <button
                class="quick-filter text-xs px-3 py-1.5 rounded-full border border-gray-300 hover:bg-gray-50 transition-colors"
                data-category="promotion">
                <i class="fas fa-gift mr-1"></i>促銷方案
            </button>
            <button
                class="quick-filter text-xs px-3 py-1.5 rounded-full border border-gray-300 hover:bg-gray-50 transition-colors"
                data-category="all">
                <i class="fas fa-eye mr-1"></i>顯示全部
            </button>
        </div>
    </div>

    <!-- 卡片檢視容器 -->
    <div id="cardView" class="max-w-6xl mx-auto p-4">
        <!-- 注射治療區塊 -->
        <div class="mb-8">
            <div class="category-header flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold flex items-center">
                        <i class="fas fa-syringe mr-3"></i>
                        A. 注射治療 / Injectable Treatments
                    </h2>
                    <p class="mt-1 opacity-90 text-sm">涉及注射藥物或填充劑進入皮膚組織</p>
                </div>
                <span class="text-sm bg-white/30 px-3 py-1 rounded-full" id="injectionCount">0 項目</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="injectionContainer">
                <!-- 注射治療項目將由 JavaScript 動態生成 -->
            </div>
        </div>

        <!-- 能量儀器治療區塊 -->
        <div class="mb-8">
            <div class="category-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-microchip mr-3"></i>
                            B. 能量儀器治療 / Energy-Based Device Treatments
                        </h2>
                        <p class="mt-1 opacity-90 text-sm">使用能量設備作用於皮膚組織，非侵入性或微侵入性</p>
                    </div>
                    <span class="text-sm bg-white/30 px-3 py-1 rounded-full" id="deviceCount">0 項目</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="deviceContainer">
                <!-- 能量儀器治療項目將由 JavaScript 動態生成 -->
            </div>
        </div>

        <!-- 促銷組合方案區塊 -->
        <div class="mb-8">
            <div class="category-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-gift mr-3"></i>
                            C. 促銷組合方案 / Promotion Bundle Programs
                        </h2>
                        <p class="mt-1 opacity-90 text-sm">套裝療程與促銷組合方案</p>
                    </div>
                    <span class="text-sm bg-white/30 px-3 py-1 rounded-full" id="promotionCount">0 項目</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="promotionContainer">
                <!-- 促銷組合方案項目將由 JavaScript 動態生成 -->
            </div>
        </div>

        <!-- 其他治療區塊 -->
        <div class="mb-8">
            <div class="category-header" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-stethoscope mr-3"></i>
                            D. 其他治療 / Other Treatments
                        </h2>
                        <p class="mt-1 opacity-90 text-sm">其他類型的醫美療程項目</p>
                    </div>
                    <span class="text-sm bg-white/30 px-3 py-1 rounded-full" id="otherCount">0 項目</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="otherContainer">
                <!-- 其他治療項目將由 JavaScript 動態生成 -->
            </div>
        </div>
    </div>

    <!-- 表格檢視容器 -->
    <div id="tableView" class="hidden px-4 py-6">
        <div class="table-container bg-white rounded-xl">
            <table class="w-full">
                <thead>
                    <tr>
                        <th>項目代碼</th>
                        <th>治療名稱</th>
                        <th>類別</th>
                        <th>價格</th>
                        <th>單位</th>
                        <th>狀態</th>
                        <th>創建日期</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="treatmentTableBody">
                    <!-- 表格數據將由 JavaScript 動態生成 -->
                </tbody>
            </table>
        </div>

        <!-- 分頁控制 -->
        <div class="flex justify-between items-center mt-6">
            <div class="text-sm text-gray-600" id="tableInfo">
                顯示 0-0 筆，共 0 筆資料
            </div>
            <div class="flex gap-2">
                <button id="prevPageBtn"
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                    上一頁
                </button>
                <button id="nextPageBtn"
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                    下一頁
                </button>
            </div>
        </div>
    </div>

    <!-- 新增/編輯治療模態框 -->
    <div id="treatmentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden shadow-xl">
            <!-- 模態框標頭 -->
            <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800" id="modalTitle">新增治療項目</h3>
                        <p class="text-sm text-gray-500 mt-1">填寫治療項目詳細資訊</p>
                    </div>
                    <button id="closeModalBtn"
                        class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- 表單內容 -->
            <div class="overflow-y-auto max-h-[70vh] p-6 custom-scrollbar">
                <form id="treatmentForm" class="space-y-6">
                    <!-- 基本資訊 -->
                    <div>
                        <h4 class="font-medium text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-info-circle text-green-600"></i>
                            基本資訊
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">項目代碼 *</label>
                                <input type="text" id="treatmentCode" name="treatmentCode" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                    placeholder="例: BOT_MASSETER">
                                <p class="text-xs text-gray-500 mt-1">唯一識別碼，建議使用英文大寫與底線</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">治療名稱 *</label>
                                <input type="text" id="treatmentName" name="treatmentName" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                    placeholder="例: 美國肉毒瘦小臉">
                            </div>
                        </div>

                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">治療類別 *</label>
                            <select id="treatmentCategory" name="treatmentCategory" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">選擇類別</option>
                                <option value="injection">注射治療</option>
                                <option value="device">能量儀器</option>
                                <option value="promotion">促銷方案</option>
                                <option value="other">其他治療</option>
                            </select>
                        </div>

                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">治療描述</label>
                            <textarea id="treatmentDescription" name="treatmentDescription" rows="3"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                placeholder="簡要描述治療項目..."></textarea>
                        </div>
                    </div>

                    <!-- 價格與單位 -->
                    <div>
                        <h4 class="font-medium text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-tag text-green-600"></i>
                            價格與單位
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">基礎價格 *</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-3 text-gray-500">$</span>
                                    <input type="number" id="basePrice" name="basePrice" required min="0" step="1"
                                        class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        placeholder="0">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">單位 *</label>
                                <select id="defaultUnit" name="defaultUnit" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">選擇單位</option>
                                    <option value="U">單位 (U)</option>
                                    <option value="條">條數</option>
                                    <option value="cc">毫升 (cc)</option>
                                    <option value="發">發數</option>
                                    <option value="次">次數</option>
                                    <option value="堂">堂數</option>
                                    <option value="方案">方案</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">建議劑量</label>
                                <input type="text" id="commonDosage" name="commonDosage"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                    placeholder="例: 30-50U">
                            </div>
                        </div>
                    </div>

                    <!-- 使用材料 -->
                    <div>
                        <h4 class="font-medium text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-boxes text-green-600"></i>
                            使用材料
                        </h4>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">材料清單</label>
                            <div id="materialsContainer" class="space-y-3 mb-4">
                                <!-- 材料項目將由 JavaScript 動態生成 -->
                            </div>
                            <button type="button" id="addMaterialBtn"
                                class="text-green-600 hover:text-green-700 text-sm font-medium flex items-center gap-2">
                                <i class="fas fa-plus"></i>
                                <span>添加材料</span>
                            </button>
                        </div>
                    </div>

                    <!-- 狀態設定 -->
                    <div>
                        <h4 class="font-medium text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-toggle-on text-green-600"></i>
                            狀態設定
                        </h4>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center">
                                <input type="radio" id="statusActive" name="status" value="active" checked
                                    class="w-4 h-4 text-green-600 focus:ring-green-500">
                                <label for="statusActive" class="ml-2 text-sm font-medium text-gray-700">啟用中</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="statusInactive" name="status" value="inactive"
                                    class="w-4 h-4 text-gray-600 focus:ring-gray-500">
                                <label for="statusInactive" class="ml-2 text-sm font-medium text-gray-700">已停用</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- 模態框底部 -->
            <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
                <button type="button" id="cancelModalBtn"
                    class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                    取消
                </button>
                <button type="button" id="saveTreatmentBtn"
                    class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                    儲存項目
                </button>
            </div>
        </div>
    </div>

    <!-- 刪除確認模態框 -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-xl">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">確認刪除</h3>
                        <p class="text-sm text-gray-500">此操作無法復原</p>
                    </div>
                </div>

                <p class="text-gray-700 mb-6" id="deleteConfirmText">
                    您確定要刪除這個治療項目嗎？
                </p>

                <div class="flex justify-end gap-3">
                    <button type="button" id="cancelDeleteBtn"
                        class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                        取消
                    </button>
                    <button type="button" id="confirmDeleteBtn"
                        class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                        確認刪除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部導航 -->
    <div
        class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-2 flex items-center justify-around">
        <a href="../staff/dashboard.html" class="flex flex-col items-center gap-1 text-gray-500">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path
                    d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
            </svg>
            <span class="text-xs">首頁</span>
        </a>
        <a href="inventory.html" class="flex flex-col items-center gap-1 text-gray-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <span class="text-xs">庫存</span>
        </a>
        <a href="treatment_catalog.html" class="flex flex-col items-center gap-1 text-green-600 -mt-6">
            <div class="bg-green-600 rounded-full p-4 shadow-lg">
                <i class="fas fa-syringe text-white text-xl"></i>
            </div>
            <span class="text-xs font-medium">治療目錄</span>
        </a>
        <a href="drug_materials.html" class="flex flex-col items-center gap-1 text-gray-500">
            <i class="fas fa-pills text-xl"></i>
            <span class="text-xs">藥材</span>
        </a>
        <a href="../sales/reports.html" class="flex flex-col items-center gap-1 text-gray-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            <span class="text-xs">報表</span>
        </a>
    </div>

    <script>
        // 治療項目資料 - 從 localStorage 讀取或初始化
        let treatments = JSON.parse(localStorage.getItem('treatments')) || [
            {
                id: generateId(),
                treatment_code: "BOT_MASSETER",
                treatment_name: "美國肉毒瘦小臉",
                category: "injection",
                default_unit: "U",
                base_price: 4999,
                description: "Botox 30U，咬肌肥厚治療",
                common_dosage: "30-50U",
                materials: ["美國肉毒桿菌素", "注射針頭 (細針)", "生理食鹽水", "消毒用品"],
                status: "active",
                created_at: new Date().toISOString().split('T')[0],
                updated_at: new Date().toISOString().split('T')[0]
            },
            {
                id: generateId(),
                treatment_code: "VERSA_HA_1CC",
                treatment_name: "薇貝拉玻尿酸 1cc",
                category: "injection",
                default_unit: "cc",
                base_price: 12000,
                description: "Versa HA Filler，玻尿酸填充劑",
                common_dosage: "1cc",
                materials: ["薇貝拉玻尿酸 (1cc)", "注射針頭", "局部麻醉劑", "消毒棉片"],
                status: "active",
                created_at: new Date().toISOString().split('T')[0],
                updated_at: new Date().toISOString().split('T')[0]
            },
            {
                id: generateId(),
                treatment_code: "HIFU_1000",
                treatment_name: "海芙音波 1000條",
                category: "device",
                default_unit: "條",
                base_price: 38000,
                description: "HIFU Lifting，臉部緊緻",
                common_dosage: "1000條",
                materials: ["海芙音波設備", "1000條治療探頭", "專用傳導凝膠", "一次性探頭膜"],
                status: "active",
                created_at: new Date().toISOString().split('T')[0],
                updated_at: new Date().toISOString().split('T')[0]
            },
            {
                id: generateId(),
                treatment_code: "PICO_LASER",
                treatment_name: "皮秒蜂巢雷射",
                category: "device",
                default_unit: "次",
                base_price: 5800,
                description: "Pico Laser，色素斑治療",
                common_dosage: "單次",
                materials: ["皮秒雷射設備", "蜂巢透鏡", "冷卻凝膠", "保護眼罩", "修復精華"],
                status: "active",
                created_at: new Date().toISOString().split('T')[0],
                updated_at: new Date().toISOString().split('T')[0]
            },
            {
                id: generateId(),
                treatment_code: "FLAWLESS_SKIN",
                treatment_name: "無瑕肌方案",
                category: "promotion",
                default_unit: "方案",
                base_price: 10000,
                description: "四選一促銷方案",
                common_dosage: "四選一",
                materials: ["皮秒蜂巢/淨膚雷射四堂", "韓國玻尿酸2支", "美國音波200條", "韓國肉毒100U+容酷針"],
                status: "active",
                created_at: new Date().toISOString().split('T')[0],
                updated_at: new Date().toISOString().split('T')[0]
            },
            {
                id: generateId(),
                treatment_code: "NABOTA_100U",
                treatment_name: "韓國肉毒 100U + 容酷針",
                category: "injection",
                default_unit: "U",
                base_price: 8888,
                description: "Nabota 100U + Contour，韓國品牌肉毒搭配脂肪溶解注射",
                common_dosage: "100U",
                materials: ["韓國肉毒桿菌素 (100U)", "容酷針 (脂肪溶解劑)", "兩種注射針頭", "消毒用品"],
                status: "active",
                created_at: new Date().toISOString().split('T')[0],
                updated_at: new Date().toISOString().split('T')[0]
            }
        ];

        // 表格分頁設定
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredTreatments = [...treatments];

        // 生成唯一 ID
        function generateId() {
            return 'treat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 初始化頁面
        document.addEventListener('DOMContentLoaded', function () {
            renderTreatments();
            setupEventListeners();
            updateCounts();
        });

        // 渲染治療項目
        function renderTreatments() {
            renderCardView();
            renderTableView();
            updateCounts();
        }

        // 渲染卡片檢視
        function renderCardView() {
            // 清空容器
            document.getElementById('injectionContainer').innerHTML = '';
            document.getElementById('deviceContainer').innerHTML = '';
            document.getElementById('promotionContainer').innerHTML = '';
            document.getElementById('otherContainer').innerHTML = '';

            // 篩選治療項目
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredTreatments = treatments.filter(treatment => {
                // 搜尋條件
                const matchesSearch = searchTerm === '' ||
                    treatment.treatment_name.toLowerCase().includes(searchTerm) ||
                    treatment.treatment_code.toLowerCase().includes(searchTerm) ||
                    (treatment.description && treatment.description.toLowerCase().includes(searchTerm));

                // 類別條件
                const matchesCategory = categoryFilter === '' || treatment.category === categoryFilter;

                // 狀態條件
                const matchesStatus = statusFilter === '' || treatment.status === statusFilter;

                return matchesSearch && matchesCategory && matchesStatus;
            });

            // 按類別分組
            const injections = filteredTreatments.filter(t => t.category === 'injection');
            const devices = filteredTreatments.filter(t => t.category === 'device');
            const promotions = filteredTreatments.filter(t => t.category === 'promotion');
            const others = filteredTreatments.filter(t => t.category === 'other');

            // 渲染注射治療
            injections.forEach(treatment => {
                const card = createTreatmentCard(treatment);
                document.getElementById('injectionContainer').appendChild(card);
            });

            // 渲染能量儀器治療
            devices.forEach(treatment => {
                const card = createTreatmentCard(treatment);
                document.getElementById('deviceContainer').appendChild(card);
            });

            // 渲染促銷方案
            promotions.forEach(treatment => {
                const card = createTreatmentCard(treatment);
                document.getElementById('promotionContainer').appendChild(card);
            });

            // 渲染其他治療
            others.forEach(treatment => {
                const card = createTreatmentCard(treatment);
                document.getElementById('otherContainer').appendChild(card);
            });

            // 更新計數
            document.getElementById('injectionCount').textContent = injections.length + ' 項目';
            document.getElementById('deviceCount').textContent = devices.length + ' 項目';
            document.getElementById('promotionCount').textContent = promotions.length + ' 項目';
            document.getElementById('otherCount').textContent = others.length + ' 項目';
        }

        // 創建治療項目卡片
        function createTreatmentCard(treatment) {
            const card = document.createElement('div');
            card.className = 'treatment-card p-4 animate-fade-in';
            card.style.borderLeftColor = getCategoryColor(treatment.category);

            // 狀態標籤
            const statusClass = treatment.status === 'active' ? 'status-active' : 'status-inactive';
            const statusText = treatment.status === 'active' ? '啟用中' : '已停用';

            // 材料標籤
            const materialsHtml = treatment.materials && treatment.materials.length > 0
                ? treatment.materials.map(material =>
                    `<span class="material-badge ${getCategoryBadgeClass(treatment.category)}">${material}</span>`
                ).join('')
                : '<span class="text-gray-400 text-sm">無材料設定</span>';

            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-900 text-lg mb-1">${treatment.treatment_name}</h3>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs text-gray-500 font-mono">${treatment.treatment_code}</span>
                            <span class="${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-purple-600 font-bold text-xl">$${treatment.base_price.toLocaleString()}</div>
                        <div class="text-sm text-gray-500">/${treatment.default_unit}</div>
                    </div>
                </div>

                ${treatment.description ? `<p class="text-sm text-gray-600 mb-4">${treatment.description}</p>` : ''}

                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">使用材料</h4>
                    <div class="flex flex-wrap">
                        ${materialsHtml}
                    </div>
                </div>

                <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
                    <div class="text-xs text-gray-500">
                        創建: ${treatment.created_at} | 更新: ${treatment.updated_at}
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-btn text-blue-600 hover:text-blue-800 p-2" data-id="${treatment.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn text-red-600 hover:text-red-800 p-2" data-id="${treatment.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        // 渲染表格檢視
        function renderTableView() {
            const tableBody = document.getElementById('treatmentTableBody');
            tableBody.innerHTML = '';

            // 計算分頁
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTreatments = filteredTreatments.slice(startIndex, endIndex);

            // 渲染表格行
            pageTreatments.forEach(treatment => {
                const row = document.createElement('tr');
                row.className = 'animate-fade-in';

                // 類別標籤
                const categoryLabel = getCategoryLabel(treatment.category);
                const categoryColor = getCategoryColor(treatment.category);

                // 狀態標籤
                const statusClass = treatment.status === 'active' ? 'status-active' : 'status-inactive';
                const statusText = treatment.status === 'active' ? '啟用中' : '已停用';

                row.innerHTML = `
                    <td class="font-mono text-sm">${treatment.treatment_code}</td>
                    <td>
                        <div class="font-medium">${treatment.treatment_name}</div>
                        ${treatment.description ? `<div class="text-xs text-gray-500 truncate max-w-xs">${treatment.description}</div>` : ''}
                    </td>
                    <td>
                        <span class="inline-block px-3 py-1 rounded-full text-xs font-medium" style="background-color: ${categoryColor}20; color: ${categoryColor};">${categoryLabel}</span>
                    </td>
                    <td class="font-bold text-purple-600">$${treatment.base_price.toLocaleString()}</td>
                    <td class="text-gray-600">${treatment.default_unit}</td>
                    <td>
                        <span class="${statusClass}">${statusText}</span>
                    </td>
                    <td class="text-sm text-gray-500">${treatment.created_at}</td>
                    <td>
                        <div class="flex gap-2">
                            <button class="edit-btn px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm" data-id="${treatment.id}">
                                <i class="fas fa-edit mr-1"></i>編輯
                            </button>
                            <button class="delete-btn px-3 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm" data-id="${treatment.id}">
                                <i class="fas fa-trash mr-1"></i>刪除
                            </button>
                        </div>
                    </td>
                `;

                tableBody.appendChild(row);
            });

            // 更新分頁資訊
            updatePaginationInfo();

            // 綁定按鈕事件
            bindTableButtonEvents();
        }

        // 更新分頁資訊
        function updatePaginationInfo() {
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, filteredTreatments.length);
            const total = filteredTreatments.length;

            document.getElementById('tableInfo').textContent =
                `顯示 ${startIndex}-${endIndex} 筆，共 ${total} 筆資料`;

            // 更新分頁按鈕狀態
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = endIndex >= total;
        }

        // 綁定表格按鈕事件
        function bindTableButtonEvents() {
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const treatmentId = this.dataset.id;
                    editTreatment(treatmentId);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const treatmentId = this.dataset.id;
                    confirmDelete(treatmentId);
                });
            });
        }

        // 更新計數
        function updateCounts() {
            // 卡片計數已在上面的 renderCardView 中更新
            // 這裡可以添加其他計數邏輯
        }

        // 獲取類別顏色
        function getCategoryColor(category) {
            switch (category) {
                case 'injection': return '#667eea';
                case 'device': return '#10b981';
                case 'promotion': return '#8b5cf6';
                case 'other': return '#f97316';
                default: return '#6b7280';
            }
        }

        // 獲取類別標籤
        function getCategoryLabel(category) {
            switch (category) {
                case 'injection': return '注射治療';
                case 'device': return '能量儀器';
                case 'promotion': return '促銷方案';
                case 'other': return '其他治療';
                default: return '未知';
            }
        }

        // 獲取類別徽章樣式
        function getCategoryBadgeClass(category) {
            switch (category) {
                case 'injection': return 'injection-badge';
                case 'device': return 'device-badge';
                case 'promotion': return 'promotion-badge';
                default: return '';
            }
        }

        // 新增治療項目
        function addTreatment() {
            // 重置表單
            document.getElementById('treatmentForm').reset();
            document.getElementById('modalTitle').textContent = '新增治療項目';
            document.getElementById('treatmentCode').removeAttribute('readonly');

            // 清空材料容器
            document.getElementById('materialsContainer').innerHTML = '';
            addMaterialField(); // 添加一個空的材料欄位

            // 顯示模態框
            document.getElementById('treatmentModal').classList.remove('hidden');
            document.getElementById('treatmentModal').classList.add('flex');

            // 設定儲存按鈕功能
            document.getElementById('saveTreatmentBtn').onclick = function () {
                saveNewTreatment();
            };
        }

        // 編輯治療項目
        function editTreatment(treatmentId) {
            const treatment = treatments.find(t => t.id === treatmentId);
            if (!treatment) return;

            // 填充表單
            document.getElementById('treatmentCode').value = treatment.treatment_code;
            document.getElementById('treatmentCode').setAttribute('readonly', true);
            document.getElementById('treatmentName').value = treatment.treatment_name;
            document.getElementById('treatmentCategory').value = treatment.category;
            document.getElementById('treatmentDescription').value = treatment.description || '';
            document.getElementById('basePrice').value = treatment.base_price;
            document.getElementById('defaultUnit').value = treatment.default_unit;
            document.getElementById('commonDosage').value = treatment.common_dosage || '';

            // 設定狀態
            document.getElementById(treatment.status === 'active' ? 'statusActive' : 'statusInactive').checked = true;

            // 填充材料
            const materialsContainer = document.getElementById('materialsContainer');
            materialsContainer.innerHTML = '';

            if (treatment.materials && treatment.materials.length > 0) {
                treatment.materials.forEach(material => {
                    addMaterialField(material);
                });
            } else {
                addMaterialField();
            }

            // 更新模態框標題
            document.getElementById('modalTitle').textContent = '編輯治療項目';

            // 顯示模態框
            document.getElementById('treatmentModal').classList.remove('hidden');
            document.getElementById('treatmentModal').classList.add('flex');

            // 設定儲存按鈕功能
            document.getElementById('saveTreatmentBtn').onclick = function () {
                saveEditedTreatment(treatmentId);
            };
        }

        // 新增材料欄位
        function addMaterialField(value = '') {
            const container = document.getElementById('materialsContainer');
            const materialId = 'material_' + Date.now();

            const materialDiv = document.createElement('div');
            materialDiv.className = 'flex gap-2 items-center';
            materialDiv.innerHTML = `
                <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" value="${value}" placeholder="輸入材料名稱">
                <button type="button" class="remove-material-btn text-red-600 hover:text-red-800 p-2">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(materialDiv);

            // 綁定移除按鈕事件
            materialDiv.querySelector('.remove-material-btn').addEventListener('click', function () {
                if (container.children.length > 1) {
                    container.removeChild(materialDiv);
                }
            });
        }

        // 儲存新治療項目
        function saveNewTreatment() {
            // 驗證表單
            if (!validateForm()) return;

            // 收集表單資料
            const materials = Array.from(document.querySelectorAll('#materialsContainer input')).map(input => input.value).filter(val => val.trim() !== '');

            const newTreatment = {
                id: generateId(),
                treatment_code: document.getElementById('treatmentCode').value.trim(),
                treatment_name: document.getElementById('treatmentName').value.trim(),
                category: document.getElementById('treatmentCategory').value,
                default_unit: document.getElementById('defaultUnit').value,
                base_price: parseInt(document.getElementById('basePrice').value),
                description: document.getElementById('treatmentDescription').value.trim(),
                common_dosage: document.getElementById('commonDosage').value.trim(),
                materials: materials,
                status: document.querySelector('input[name="status"]:checked').value,
                created_at: new Date().toISOString().split('T')[0],
                updated_at: new Date().toISOString().split('T')[0]
            };

            // 添加到陣列
            treatments.push(newTreatment);

            // 儲存到 localStorage
            localStorage.setItem('treatments', JSON.stringify(treatments));

            // 關閉模態框
            document.getElementById('treatmentModal').classList.add('hidden');
            document.getElementById('treatmentModal').classList.remove('flex');

            // 重新渲染
            renderTreatments();

            // 顯示成功訊息
            showToast('治療項目已成功新增！', 'success');
        }

        // 儲存編輯的治療項目
        function saveEditedTreatment(treatmentId) {
            // 驗證表單
            if (!validateForm()) return;

            // 收集表單資料
            const materials = Array.from(document.querySelectorAll('#materialsContainer input')).map(input => input.value).filter(val => val.trim() !== '');

            // 更新治療項目
            const index = treatments.findIndex(t => t.id === treatmentId);
            if (index !== -1) {
                treatments[index] = {
                    ...treatments[index],
                    treatment_name: document.getElementById('treatmentName').value.trim(),
                    category: document.getElementById('treatmentCategory').value,
                    default_unit: document.getElementById('defaultUnit').value,
                    base_price: parseInt(document.getElementById('basePrice').value),
                    description: document.getElementById('treatmentDescription').value.trim(),
                    common_dosage: document.getElementById('commonDosage').value.trim(),
                    materials: materials,
                    status: document.querySelector('input[name="status"]:checked').value,
                    updated_at: new Date().toISOString().split('T')[0]
                };

                // 儲存到 localStorage
                localStorage.setItem('treatments', JSON.stringify(treatments));

                // 關閉模態框
                document.getElementById('treatmentModal').classList.add('hidden');
                document.getElementById('treatmentModal').classList.remove('flex');

                // 重新渲染
                renderTreatments();

                // 顯示成功訊息
                showToast('治療項目已成功更新！', 'success');
            }
        }

        // 驗證表單
        function validateForm() {
            const requiredFields = [
                'treatmentCode',
                'treatmentName',
                'treatmentCategory',
                'basePrice',
                'defaultUnit'
            ];

            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.focus();
                    field.classList.add('border-red-500');
                    showToast(`請填寫 ${field.labels[0].textContent}`, 'error');
                    return false;
                }
                field.classList.remove('border-red-500');
            }

            return true;
        }

        // 確認刪除
        function confirmDelete(treatmentId) {
            const treatment = treatments.find(t => t.id === treatmentId);
            if (!treatment) return;

            document.getElementById('deleteConfirmText').textContent =
                `您確定要刪除「${treatment.treatment_name}」這個治療項目嗎？此操作無法復原。`;

            // 顯示刪除確認模態框
            document.getElementById('deleteModal').classList.remove('hidden');
            document.getElementById('deleteModal').classList.add('flex');

            // 設定確認刪除按鈕功能
            document.getElementById('confirmDeleteBtn').onclick = function () {
                deleteTreatment(treatmentId);
            };
        }

        // 刪除治療項目
        function deleteTreatment(treatmentId) {
            // 從陣列中移除
            treatments = treatments.filter(t => t.id !== treatmentId);

            // 儲存到 localStorage
            localStorage.setItem('treatments', JSON.stringify(treatments));

            // 關閉刪除確認模態框
            document.getElementById('deleteModal').classList.add('hidden');
            document.getElementById('deleteModal').classList.remove('flex');

            // 重新渲染
            renderTreatments();

            // 顯示成功訊息
            showToast('治療項目已成功刪除！', 'success');
        }

        // 顯示提示訊息
        function showToast(message, type = 'info') {
            // 創建 toast 元素
            const toast = document.createElement('div');
            toast.className = `fixed top-20 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium animate-fade-in ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            toast.textContent = message;

            document.body.appendChild(toast);

            // 3秒後移除
            setTimeout(() => {
                toast.classList.remove('animate-fade-in');
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // 設定事件監聽器
        function setupEventListeners() {
            // 檢視切換
            document.getElementById('viewToggle').addEventListener('click', function () {
                const cardView = document.getElementById('cardView');
                const tableView = document.getElementById('tableView');
                const toggleBtn = document.getElementById('viewToggle');

                if (cardView.classList.contains('hidden')) {
                    // 切換到卡片檢視
                    cardView.classList.remove('hidden');
                    tableView.classList.add('hidden');
                    toggleBtn.innerHTML = '<i class="fas fa-th-list text-xs"></i><span>列表檢視</span>';
                } else {
                    // 切換到表格檢視
                    cardView.classList.add('hidden');
                    tableView.classList.remove('hidden');
                    toggleBtn.innerHTML = '<i class="fas fa-th-large text-xs"></i><span>卡片檢視</span>';
                }
            });

            // 新增治療項目按鈕
            document.getElementById('addTreatmentBtn').addEventListener('click', addTreatment);

            // 搜尋輸入
            document.getElementById('searchInput').addEventListener('input', renderTreatments);

            // 篩選選擇
            document.getElementById('categoryFilter').addEventListener('change', renderTreatments);
            document.getElementById('statusFilter').addEventListener('change', renderTreatments);

            // 快速篩選
            document.querySelectorAll('.quick-filter').forEach(btn => {
                btn.addEventListener('click', function () {
                    const category = this.dataset.category;

                    if (category === 'all') {
                        document.getElementById('categoryFilter').value = '';
                    } else {
                        document.getElementById('categoryFilter').value = category;
                    }

                    renderTreatments();
                });
            });

            // 模態框關閉按鈕
            document.getElementById('closeModalBtn').addEventListener('click', function () {
                document.getElementById('treatmentModal').classList.add('hidden');
                document.getElementById('treatmentModal').classList.remove('flex');
            });

            document.getElementById('cancelModalBtn').addEventListener('click', function () {
                document.getElementById('treatmentModal').classList.add('hidden');
                document.getElementById('treatmentModal').classList.remove('flex');
            });

            // 添加材料按鈕
            document.getElementById('addMaterialBtn').addEventListener('click', function () {
                addMaterialField();
            });

            // 刪除確認模態框關閉
            document.getElementById('cancelDeleteBtn').addEventListener('click', function () {
                document.getElementById('deleteModal').classList.add('hidden');
                document.getElementById('deleteModal').classList.remove('flex');
            });

            // 分頁按鈕
            document.getElementById('prevPageBtn').addEventListener('click', function () {
                if (currentPage > 1) {
                    currentPage--;
                    renderTableView();
                }
            });

            document.getElementById('nextPageBtn').addEventListener('click', function () {
                const totalPages = Math.ceil(filteredTreatments.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTableView();
                }
            });

            // 委派編輯和刪除按鈕事件（用於動態生成的元素）
            document.addEventListener('click', function (e) {
                // 卡片檢視中的編輯按鈕
                if (e.target.closest('.edit-btn')) {
                    const treatmentId = e.target.closest('.edit-btn').dataset.id;
                    editTreatment(treatmentId);
                }

                // 卡片檢視中的刪除按鈕
                if (e.target.closest('.delete-btn')) {
                    const treatmentId = e.target.closest('.delete-btn').dataset.id;
                    confirmDelete(treatmentId);
                }
            });
        }
    </script>
</body>

</html>